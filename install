#!/usr/bin/env bash

# ref
# - http://qiita.com/b4b4r07/items/24872cdcbec964ce2178#deploy
# - https://github.com/izumin5210/dotfiles/blob/438d5d82378b684500abfded0e92362a0cd500e0/install

set -eu

has() {
  return $(type $1 >/dev/null 2>&1)
}

SYSTEM=$(uname -s)
HOSTNAME="${HOSTNAME:-$(hostname)}"
HOSTNAME="${HOSTNAME%.local}"
REPO="github.com/potsbo/dotfiles"
DOTPATH="${HOME}/src/${REPO}"

# Step 0 validation
case "$HOSTNAME" in
staten | tigerlake | raptorlake | phoenix) CONFIG="$HOSTNAME" ;;
*)
  if [[ "$SYSTEM" == "Darwin" ]] || [[ -e /etc/NIXOS ]]; then
    echo "Unknown hostname: $HOSTNAME"
    echo "Hint: HOSTNAME=<hostname> curl ... | bash"
    exit 1
  fi
  CONFIG="linux"
  ;;
esac

# Step 1 clone
if [ ! -d $DOTPATH ]; then
  echo "$DOTPATH not found. Cloning..."
  mkdir -p "$(dirname ${DOTPATH})"

  if [[ -e /etc/NIXOS ]]; then
    nix-shell -p git --run "git clone --recursive https://${REPO} ${DOTPATH}"
  else
    git clone --recursive https://${REPO} ${DOTPATH}
  fi
fi

cd $DOTPATH

if [ $? -ne 0 ]; then
  exit 1
fi

# nix configuration (potsbo ユーザーのみ)
# nix の設定を potsbo と hard code していることが理由
# 「nix を install できる環境」と「user が potsbo である」は一致することがほとんどのハズ
if [[ "$USER" == "potsbo" ]]; then
  if ! has "nix"; then
    echo "Installing Nix..."
    curl -L https://nixos.org/nix/install | sh -s
    . "$HOME/.nix-profile/etc/profile.d/nix.sh"
  fi

  export NIX_CONFIG="experimental-features = nix-command flakes"

  # nixos-rebuild (NixOS only)
  if [[ -e /etc/NIXOS ]]; then
    NIXOS_CONFIG="${DOTPATH}/nixos/hosts/${CONFIG}/configuration.nix"
    if [[ ! -e "$NIXOS_CONFIG" ]]; then
      echo "Error: NixOS configuration not found: $NIXOS_CONFIG"
      echo "Hint: HOSTNAME=<hostname> curl ... | bash"
      exit 1
    fi
    sudo ln -sf "$NIXOS_CONFIG" /etc/nixos/configuration.nix
    sudo nixos-rebuild switch
  fi

  nix run home-manager -- switch --flake "${DOTPATH}/nix#$CONFIG"

  # nix-darwin (macOS only)
  if [[ "$SYSTEM" == "Darwin" ]]; then
    # Install Homebrew if not present (required for nix-darwin homebrew module)
    if ! has "brew"; then
      echo "Installing Homebrew..."
      NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    echo "nix-darwin: Using configuration: $CONFIG"
    sudo -H nix --extra-experimental-features 'nix-command flakes' run "${DOTPATH}/nix" -- switch --flake "${DOTPATH}/nix#$CONFIG" --verbose
  fi
fi

if [ "${CODESPACES:-"false"}" = "true" ]; then
  # codespaces で sudo が command not found になったため入れていない
  # もしかしたら codespaces の環境によっては必要かもしれない
  apt update

  # ghq のために workspace 自体もリンクする
  mkdir -p "${HOME}/src/github.com/$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)"
  TARGET_REPO_PATH="${HOME}/src/github.com/${GITHUB_REPOSITORY}"
  if [ ! -e "${TARGET_REPO_PATH}" ]; then
    # 起動時は CODESPACE_VSCODE_FOLDER が使えなかったので手動で構築
    ln -s "/workspaces/$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)" "${TARGET_REPO_PATH}"
  fi

  # 任意の場所から aqua が使えるようにしておく
  ln -s "$HOME/aqua.yaml" /aqua.yaml
fi

# mitamae が ~/aqua.yaml をリンクするが、mitamae 自体が aqua 経由で動くため
# 先に aqua.yaml の場所を環境変数で指定して循環参照を断ち切る
export AQUA_GLOBAL_CONFIG="${DOTPATH}/config/.config/aquaproj-aqua/aqua.yaml"

if has "aqua"; then
  aqua install --only-link
  aqua exec mitamae local lib/recipe.rb
fi
