#!/bin/bash

set -eu

ARGS=('')
for a in "$@"; do
  ARGS=(${ARGS[@]} "$a")
done

ansible_check() {
  if brew info asible | grep "Not installed" > /dev/null 2>&1
  then
    echo "    + Installing ansible..."
    brew install ansible
  else
    echo "    + ansible found."
  fi
}

install_brew() {
  echo "  + Homebrew"
  if test ! $(which brew); then
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  else
    echo "    + Homebrew found."
  fi
}

link_check() {
  if [[ ! -f "$2" && ! -d "$2" && ! -L "$2" ]]; then
    ln -s $1 $2
  fi
}

# Config
echo "  + Machine Name"
MACHINE=${MACHINE:-$(hostname | sed -e 's/\.local//g')}
if [[ $MACHINE =~ ^[a-z]+$ ]]; then
  echo "    + $MACHINE is valid."
else
  echo "    + $MACHINE is not valid."
  exit 1
fi

echo "  + Permission"
fix_permission() {
  [ -d /usr/local ] || mkdir -p /usr/local
  [ "$(stat -f '%Su' /usr/local)" = "$(whoami)" ] && echo '    + ok' && return  # GNU: stat -c '%U'

  echo '    + Fixing permission of /usr/local...'
  sudo chown -R $(whoami) /usr/local
  echo '      + done'
}
fix_permission

echo "  + SSH key"
echo "    + general key"
KEY_PATH=~/.ssh/$MACHINE
if [[ ! -f "$KEY_PATH" && ! -L "$KEY_PATH" ]]; then
  ssh-keygen -f $KEY_PATH -t rsa -N ''
else
  echo "      + $KEY_PATH exists."
fi
link_check $KEY_PATH ~/.ssh/id_rsa

echo "    + GitHub key"
KEY_PATH=~/.ssh/$MACHINE.github
if [[ ! -f "$KEY_PATH" && ! -L "$KEY_PATH" ]]; then
  ssh-keygen -f $KEY_PATH -t rsa -N ''
else
  echo "      + $KEY_PATH exists."
fi
link_check $KEY_PATH ~/.ssh/id_rsa.github

# Install rew

install_brew
ansible_check

echo "  + Rust"
if test ! $(which rustc); then
  curl https://sh.rustup.rs -sSf | sh -s -- -y
fi

# ansible
provisioning/run.sh ${ARGS[@]}
