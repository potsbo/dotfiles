#!/bin/bash

set -eu

ARGS=('')
for a in "$@"; do
  ARGS=(${ARGS[@]} "$a")
done

ansible_check() {
  if brew info ansible | grep "Not installed" > /dev/null 2>&1
  then
    echo "    + Installing ansible..."
    brew install ansible
  else
    echo "    + ansible found."
  fi
}

install_brew() {
  echo "  + Homebrew"
  if test ! $(which brew); then
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  else
    echo "    + Homebrew found."
  fi
}

link_check() {
  if [[ ! -f "$2" && ! -d "$2" && ! -L "$2" ]]; then
    ln -s $1 $2
  fi
}

check_name() {
  echo "  + Machine Name"
  MACHINE=${MACHINE:-$(hostname | sed -e 's/\.local//g')}
  if [[ $MACHINE =~ ^[a-z\-]+$ ]]; then
    echo "    + $MACHINE is valid."
  else
    echo "    + $MACHINE is not valid."
    exit 1
  fi
}

set_ssh_key() {
  echo "  + SSH key"

  KEYS=($MACHINE $MACHINE.github)
  for name in ${KEYS[@]}; do
    path=~/.ssh/$name
    if [[ ! -f "$path" && ! -L "$path" ]]; then
      ssh-keygen -f $path -t rsa -N ''
    else
      echo "      + $name exists."
    fi
    link_check $path ~/.ssh/$name
  done
}

check_name
set_ssh_key
install_brew
ansible_check

# ansible
provisioning/run.sh ${ARGS[@]}
