#!/bin/bash

set -eu

brew_check() {
  if brew info $1 | grep "Not installed" > /dev/null 2>&1
  then
    echo "    + Installing $1..."
    brew install $1
  else
    echo "    + $1 found."
  fi
}

link_check() {
  if [[ ! -f "$2" && ! -d "$2" && ! -L "$2" ]]; then
    ln -s $1 $2
  fi
}

replace_with_link() {
  if [[ -L "$2" || -f "$2" ]]; then
    rm $2
  fi
  link_check $1 $2
  echo "    + $2 updated."
}

clone_and_link_to() {
  ghq get $1
  replace_with_link $SRC_DIR/github.com/$1 $2
}

install_zsh_theme() {
  filename=$(basename $1)
  if [ ! -f "$HOME/.oh-my-zsh/themes/$filename" ]; then
    wget $1 -P $HOME/.oh-my-zsh/themes
  else
    echo "    + $filename found."
  fi
}

# Config
SRC_DIR=$HOME/src
DOTFILES_DIR=$HOME/.dotfiles
TMUX_DIR=$HOME/.tmux
PYTHON_VERSION=3.6.1
RUBY_VERSION=2.4.1
NODE_VERSION=7.9.0
export GHQ_ROOT=$SRC_DIR

# PATH
export GOPATH=$HOME/.go
export PATH=$PATH:$GOPATH/bin

echo "  + Machine Name"
MACHINE=$(hostname | sed -e 's/\.local//g')
if [[ $MACHINE =~ ^[a-z]+$ ]]; then
  echo "    + $MACHINE is valid."
else
  echo "    + $MACHINE is not valid."
  exit 1
fi

echo "  + SSH key"
echo "    + general key"
KEY_PATH=~/.ssh/$MACHINE
if [[ ! -f "$KEY_PATH" && ! -L "$KEY_PATH" ]]; then
  ssh-keygen -f $KEY_PATH -t rsa
else
  echo "    + $KEY_PATH exists."
fi

echo "    + GitHub key"
KEY_PATH=~/.ssh/$MACHINE.github
if [[ ! -f "$KEY_PATH" && ! -L "$KEY_PATH" ]]; then
  ssh-keygen -f $KEY_PATH -t rsa
else
  echo "    + $KEY_PATH exists."
fi

# Install brew
echo "  + Homebrew"
if test ! $(which brew); then
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
else
  echo "    + Homebrew found."
fi

echo "  + Go"
# Check go
brew_check go
mkdir -p $GOPATH
mkdir -p $SRC_DIR
link_check $HOME/src $GOPATH/src

# ghq
echo "  + ghq"
if test ! $(which ghq); then
  go get github.com/motemen/ghq
else
  echo "    + ghq found."
fi

# dotfiles
echo "  + dotfiles"
clone_and_link_to potsbo/dotfiles $DOTFILES_DIR
CONFS=(.vimrc .zshrc .gitconfig .gitignore_global .tmux.conf .tmux-powerlinerc)
for conf in ${CONFS[@]}; do
  replace_with_link $HOME/.dotfiles/$conf $HOME/$conf
done

echo "  + .ssh"
mkdir -p $HOME/.ssh
link_check $DOTFILES_DIR/.ssh/config $HOME/.ssh/config

# tmux
echo "  + Tmux"
brew_check tmux
mkdir -p $HOME/.tmux
clone_and_link_to potsbo/tmux-powerline $TMUX_DIR/tmux-powerline

# Tools
echo "  + Tools"
brew_check peco
brew_check hub
brew_check jq
brew_check wget
brew_check envchain

# rbenv
echo "  + Ruby"
brew_check rbenv
if rbenv versions | grep $RUBY_VERSION > /dev/null 2>&1
then
  echo "    + ruby $RUBY_VERSION fonud."
else
  rbenv install $RUBY_VERSION
  gem install bundler
fi
rbenv global $RUBY_VERSION

# pyenv
echo "  + Python"
brew_check pyenv
if pyenv versions | grep $PYTHON_VERSION > /dev/null 2>&1
then
  echo "    + python $PYTHON_VERSION fonud."
else
  pyenv install $PYTHON_VERSION
fi
pyenv global $PYTHON_VERSION

echo "  + Node"
brew_check nodenv
if nodenv versions | grep $NODE_VERSION > /dev/null 2>&1
then
  echo "    + node $NODE_VERSION found."
else
  nodenv install $NODE_VERSION
fi
nodenv global $NODE_VERSION

# oh-my-zsh
echo "  + oh-my-zsh"
clone_and_link_to robbyrussell/oh-my-zsh $HOME/.oh-my-zsh
install_zsh_theme https://gist.githubusercontent.com/xfanwu/18fd7c24360c68bab884/raw/f09340ac2b0ca790b6059695de0873da8ca0c5e5/xxf.zsh-theme

# vim
echo "  + Vim"
mkdir -p $HOME/.vim/bundle
clone_and_link_to Shougo/neobundle.vim $HOME/.vim/bundle/neobundle.vim
link_check $DOTFILES_DIR/vim/indent $HOME/.vim/indent

# assets
echo "  + Assets"
ghq get edihbrandon/RictyDiminished
ghq get mzyy94/RictyDiminished-for-Powerline
