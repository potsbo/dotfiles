#!/bin/sh
set -e

mitamae_version="1.12.9"

# arch が無い環境（NixOSなど）に備えて uname -m を使う
machine="$(uname -m)"
# macOS では arm64 表記なので aarch64 に寄せる
if [ "$machine" = "arm64" ]; then
  machine="aarch64"
fi

architecture=aarch64
if [ "$machine" = "x86_64" ]; then
  architecture=x86_64
fi
if [ "$machine" = "i386" ]; then
  architecture=x86_64
fi

os="darwin"
if [ "$(uname)" = "Linux" ]; then
  os="linux"
fi

mitamae_cache="mitamae-${architecture}-${mitamae_version}"
if ! [ -f "bin/${mitamae_cache}" ]; then
  mitamae_bin="mitamae-${architecture}-${os}"

  curl -o "bin/${mitamae_bin}.tar.gz" -fL "https://github.com/itamae-kitchen/mitamae/releases/download/v${mitamae_version}/${mitamae_bin}.tar.gz"
  tar xvzf "bin/${mitamae_bin}.tar.gz"

  rm "bin/${mitamae_bin}.tar.gz"
  mv "${mitamae_bin}" "bin/${mitamae_cache}"
  chmod +x "bin/${mitamae_cache}"
fi
ln -sf "${mitamae_cache}" bin/mitamae
